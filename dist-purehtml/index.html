<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>game_experiments</title>
    <script type="module" crossorigin>(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function o(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=o(s);fetch(s.href,n)}})();const I=1e-9,x=t=>`${t[0]},${t[1]},${t[2]}`,U=t=>{const e=t.split(",");if(e.length!==3)throw new Error(`Invalid CubeKey: "${t}"`);const o=Number(e[0]),i=Number(e[1]),s=Number(e[2]);return[o,i,s]},ne=(t,e)=>[t[0]+e[0],t[1]+e[1],t[2]+e[2]],be=(t,e)=>[t[0]-e[0],t[1]-e[1],t[2]-e[2]],xe=(t,e)=>[t[0]*e,t[1]*e,t[2]*e],ve=t=>(Math.abs(t[0])+Math.abs(t[1])+Math.abs(t[2]))/2,Ee=(t,e)=>ve(be(t,e)),V=[[1,-1,0],[1,0,-1],[0,1,-1],[-1,1,0],[-1,0,1],[0,-1,1]],ce=t=>{const e=(t%6+6)%6;return V[e]},Ce=(t,e)=>ne(t,ce(e)),we=t=>[t[0],t[2]],ke=(t,e)=>{const o=[];for(let i=-e;i<=e;i++)for(let s=Math.max(-e,-i-e);s<=Math.min(e,-i+e);s++){const n=-i-s;o.push(ne(t,[i,s,n]))}return o},Ie=(t,e)=>{if(e<0)return[];if(e===0)return[t];let o=ne(t,xe(ce(4),e));const i=[];for(let s=0;s<6;s++)for(let n=0;n<e;n++)i.push(o),o=Ce(o,s);return i},Te=(t,e=[0,0,0])=>ke(e,t),W=(t,e)=>{const[o,i]=we(t),{size:s,origin:n,orientation:r}=e;if(r==="pointy"){const l=s.x*(Math.sqrt(3)*o+Math.sqrt(3)/2*i),a=s.y*(3/2*i);return{x:l+n.x,y:a+n.y}}else{const l=s.x*(1.5*o),a=s.y*(Math.sqrt(3)/2*o+Math.sqrt(3)*i);return{x:l+n.x,y:a+n.y}}};function G(t,e,o){return(e.x-t.x)*(o.y-t.y)-(e.y-t.y)*(o.x-t.x)}function Y(t,e,o){return Math.min(t.x,e.x)-I<=o.x&&o.x<=Math.max(t.x,e.x)+I&&Math.min(t.y,e.y)-I<=o.y&&o.y<=Math.max(t.y,e.y)+I&&Math.abs(G(t,e,o))<=I}function Se(t,e,o,i){const s=G(t,e,o),n=G(t,e,i),r=G(o,i,t),l=G(o,i,e);return!!((s>I&&n<-I||s<-I&&n>I)&&(r>I&&l<-I||r<-I&&l>I)||Math.abs(s)<=I&&Y(t,e,o)||Math.abs(n)<=I&&Y(t,e,i)||Math.abs(r)<=I&&Y(o,i,t)||Math.abs(l)<=I&&Y(o,i,e))}function Me(t,e){let o=0;for(let i=0;i<e.length;i++){const s=e[i],n=e[(i+1)%e.length],r=G(s,n,t);if(Math.abs(r)<=I)continue;const l=r>0?1:-1;if(o===0)o=l;else if(o!==l)return!1}return!0}function $e(t,e,o){for(let s=0;s<o.length;s++){const n=o[s],r=o[(s+1)%o.length];if(Se(t,e,n,r))return!0}const i={x:(t.x+e.x)/2,y:(t.y+e.y)/2};return!!Me(i,o)}function te(t,e){const o=W(t,e),i=e.size?.x??e.size?.X,s=e.size?.y??e.size?.Y,n=e.orientation?.startAngle??0;if(typeof i!="number"||typeof s!="number")throw new Error("hexCorners: layout.size.x/y not found; use your hexlib corner helper instead.");const r=[];for(let l=0;l<6;l++){const a=2*Math.PI*(n+l)/6;r.push({x:o.x+i*Math.cos(a),y:o.y+s*Math.sin(a)})}return r}function Le(t,e,o,i,s){const n=te(t,o),r=te(e,o),l=[];for(const a of s){const p=U(a);if(!i(p))continue;const u=te(p,o),f=W(p,o),m=u.map(E=>({x:f.x+(E.x-f.x)*1.1,y:f.y+(E.y-f.y)*1.1}));l.push(m)}for(const a of n)for(const p of r){let u=!1;for(const f of l)if($e(a,p,f)){u=!0;break}if(!u)return Ee(t,e)}return NaN}const Pe={size:{x:1,y:1},origin:{x:0,y:0},orientation:"pointy"},Ae=.05,Ne=.05,ze=.05;function Be(t){const e={...t,entities:new Map(t.entities),E:new Map(t.E),capacitors:new Map,reservoirs:new Map,totalEnergyCollected:new Map(t.totalEnergyCollected),lastTickEnergy:new Map,lastCapacitorDelta:new Map,lastDeltaE:new Map,lastPerimeterEnergy:0,tickCount:t.tickCount+1};for(const[c,d]of t.capacitors)e.capacitors.set(c,{...d});for(const[c,d]of t.reservoirs)e.reservoirs.set(c,{...d,radiator:{...d.radiator}});const{diffusionAlpha:o,baseConductivity:i}=t,s=[],n=[],r=[],l=[];for(const c of t.entities.values())c.type==="source"?s.push(c):c.type==="sink"?n.push(c):c.type==="shield"?r.push(c):c.type==="probe"&&l.push(c);const a=new Set;for(const c of r){if(c.destroyed)continue;const d=x(c.pos),y=t.E.get(d)??0,C=c.heatTolerance??2e3;if(y>C&&Math.random()<Ae){const w={...c,destroyed:!0};e.entities.set(d,w),a.add(d)}}const p=new Set;for(const c of n){if(c.destroyed)continue;const d=x(c.pos),y=t.E.get(d)??0,C=c.heatTolerance??1400;if(y>C&&Math.random()<Ne){const w={...c,destroyed:!0};e.entities.set(d,w),p.add(d)}}for(const c of l){if(c.destroyed)continue;const d=x(c.pos),y=t.E.get(d)??0,C=c.heatTolerance??1800;if(y>C&&Math.random()<ze){const w={...c,destroyed:!0};e.entities.set(d,w)}}const u=new Set;for(const c of r){const d=x(c.pos);if(a.has(d)||c.destroyed)continue;c.groupId!==void 0&&t.disabledShieldGroups.has(c.groupId)||u.add(d)}const f=c=>u.has(x(c)),m=new Set;for(const c of l){const d=x(c.pos);if(e.entities.get(d)?.destroyed){m.add(d);continue}if(c.destroyed){m.add(d);continue}let C=!1;for(const w of s){if(!w.active)continue;const N=Le(c.pos,w.pos,Pe,f,u);if(!Number.isNaN(N)){C=!0;break}}if(C){const w=x(c.pos);e.entities.set(w,{...c,destroyed:!0}),m.add(w)}}const E=new Map;for(const[c,d]of e.capacitors)E.set(c,d.stored);const b=new Map;for(const[c,d]of t.probeThrottles)b.set(c,d);for(const[c,d]of e.capacitors)d.stored>=d.capacity&&b.set(c,0),d.stored=Math.max(0,d.stored-d.drainRate),d.stored>d.capacity&&(d.stored=d.capacity);for(const c of n){const d=e.reservoirs.get(c.groupId);if(d){const y=Math.max(1,d.volume),C=d.heat/y,w=x(c.pos);e.E.set(w,C)}}const g=new Map;for(const c of e.E.keys())g.set(c,i);for(const c of r){if(c.groupId!==void 0&&t.disabledShieldGroups.has(c.groupId))continue;const d=x(c.pos);if(!e.E.has(d))continue;const y=g.get(d)??i;g.set(d,Math.min(y,ae(c.conductivity)))}for(const c of n){const d=x(c.pos);if(!e.E.has(d))continue;const y=g.get(d)??i;g.set(d,Math.min(y,ae(c.conductivity)))}const h=new Map;for(const c of s){if(!c.active)continue;const d=x(c.pos);if(!e.E.has(d))continue;let y=1;c.groupId!==void 0&&(y=t.groupThrottles.get(c.groupId)??1);const C=c.power*y;e.E.set(d,(e.E.get(d)??0)+C),h.set(d,(h.get(d)??0)+C)}const v=new Map;for(const c of e.E.keys())v.set(c,0);const J=[V[0],V[1],V[2]];for(const c of e.E.keys()){const d=U(c),y=e.E.get(c)??0,C=g.get(c)??i;for(const[w,N,H]of J){const z=[d[0]+w,d[1]+N,d[2]+H],L=x(z);if(!e.E.has(L))continue;const O=e.E.get(L)??0,R=g.get(L)??i,F=Math.min(C,R)*o*(y-O);v.set(c,(v.get(c)??0)-F),v.set(L,(v.get(L)??0)+F)}}const D=new Set;for(const c of n)D.add(x(c.pos));for(const c of n){const d=x(c.pos),y=e.reservoirs.get(c.groupId);if(y){const C=h.get(d)??0,w=v.get(d)??0,N=C+w;y.heat+=N}}for(const c of e.reservoirs.values())if(c.radiator.deployed){const d=Math.min(c.heat,c.radiator.strength);c.heat-=d}for(const[c,d]of v.entries())D.has(c)||e.E.set(c,(e.E.get(c)??0)+d);for(const c of n){const d=e.reservoirs.get(c.groupId);if(d){const y=x(c.pos),C=Math.max(1,d.volume);e.E.set(y,d.heat/C)}}const M=new Map,j=.9,re=.3,_=new Map;for(const c of l){const d=x(c.pos);if(m.has(d))continue;const y=c.groupId??1;_.has(y)||_.set(y,[]),_.get(y).push(x(c.pos))}for(const[c,d]of _.entries()){const y=b.get(c)??0;if(y<=0)continue;let C=1/0;if(e.capacitors.has(c)){const T=e.capacitors.get(c),P=T.capacity-T.stored;if(P<=0)continue;C=P}let w=0,N=0;const H=new Map;for(const T of d){if(!e.E.has(T))continue;const P=e.E.get(T)??0;H.set(T,P),w+=P,N++}if(N<2)continue;const z=w/N;let L=0,O=0;for(const T of H.values())T>z?L+=T-z:O+=z-T;if(L<1e-4)continue;let R=L*y*j;const Q=C/re;R>Q&&(R=Q);const F=R*re,me=R-F;for(const[T,P]of H.entries()){let Z=0;if(P>z){const ee=(P-z)/L;Z=-1*R*ee}else if(P<z&&O>0){const ee=(z-P)/O;Z=me*ee}e.E.set(T,(e.E.get(T)??0)+Z)}if(M.set(c,F),e.capacitors.has(c)){const T=e.capacitors.get(c);T.stored=Math.min(T.capacity,T.stored+F)}}for(const[c,d]of e.E.entries()){const y=Math.abs(d)<1e-12?0:d,C=t.E.get(c)??0;e.lastDeltaE.set(c,y-C),e.E.set(c,y)}for(const[c,d]of e.capacitors){const y=E.get(c)??d.stored;e.lastCapacitorDelta.set(c,d.stored-y)}e.lastTickEnergy=M;for(const[c,d]of M){const y=e.totalEnergyCollected.get(c)??0;e.totalEnergyCollected.set(c,y+d)}let le=0;const ge=Ie([0,0,0],t.radius);for(const c of ge){const d=x(c);le+=e.E.get(d)??0}return e.lastPerimeterEnergy=le,{energyCollected:M,nextState:e}}function ae(t){return t<0?0:t}class De{state;constructor(e,o=8){if(this.state={entities:new Map,E:new Map,capacitors:new Map,reservoirs:new Map,groupThrottles:new Map,probeThrottles:new Map,disabledShieldGroups:new Set,totalEnergyCollected:new Map,lastTickEnergy:new Map,lastCapacitorDelta:new Map,lastDeltaE:new Map,lastPerimeterEnergy:0,tickCount:0,radius:o,diffusionAlpha:.1,baseConductivity:1},e)for(const i of e)this.state.E.set(i,0);for(const i of[1,2,3,4])this.state.groupThrottles.set(i,1),this.state.probeThrottles.set(i,0),this.state.totalEnergyCollected.set(i,0),this.state.capacitors.set(i,{id:i,stored:0,capacity:1e3,drainRate:1,surchargeCost:500});for(const i of[1,2,3,4,5,6])this.state.reservoirs.set(i,{id:i,heat:0,volume:5e3,radiator:{deployed:!1,strength:50}})}tick(){const e=Be(this.state);this.state=e.nextState}dischargeBank(e){const o=this.state.capacitors.get(e);return o&&o.stored>=o.surchargeCost?(o.stored-=o.surchargeCost,!0):!1}toggleShieldGroup(e){if(this.state.disabledShieldGroups.has(e)){this.state.disabledShieldGroups.delete(e);for(const[o,i]of this.state.entities)i.type==="shield"&&i.groupId===e&&i.retainedE!==void 0&&(this.state.E.set(o,i.retainedE),i.retainedE=void 0)}else{this.state.disabledShieldGroups.add(e);for(const[o,i]of this.state.entities)i.type==="shield"&&i.groupId===e&&(i.retainedE=this.state.E.get(o)||0,this.state.E.set(o,0))}}setEntity(e,o){const i=U(e);if(o==="empty"){this.state.entities.delete(e);return}let s;switch(o){case"source":s={type:"source",pos:i,power:10,active:!0,minActivation:0,groupId:1};break;case"sink":s={type:"sink",pos:i,pullRate:.1,conductivity:.8,groupId:1,heatTolerance:1400};break;case"shield":s={type:"shield",pos:i,conductivity:1e-4,groupId:1,heatTolerance:2e3};break;case"probe":s={type:"probe",pos:i,groupId:1,heatTolerance:1800};break}this.state.entities.set(e,s)}serialize(){return JSON.stringify({entities:Array.from(this.state.entities.entries()),capacitors:Array.from(this.state.capacitors.entries()),reservoirs:Array.from(this.state.reservoirs.entries()),groupThrottles:Array.from(this.state.groupThrottles.entries()),probeThrottles:Array.from(this.state.probeThrottles.entries()),disabledShieldGroups:Array.from(this.state.disabledShieldGroups)})}deserialize(e){try{const o=JSON.parse(e);if(this.state.entities.clear(),o.entities)for(const[i,s]of o.entities)s.type==="sink"&&s.groupId===void 0&&(s.groupId=1,console.log("Migrated legacy sink to Group 1")),s.type==="sink"&&"stored"in s&&(delete s.stored,delete s.capacityScale,delete s.dumpMax),this.state.entities.set(i,s);if(o.capacitors){this.state.capacitors.clear();for(const[i,s]of o.capacitors)this.state.capacitors.set(i,s)}if(o.reservoirs){this.state.reservoirs.clear();for(const[i,s]of o.reservoirs)this.state.reservoirs.set(i,{...s,radiator:s.radiator||{deployed:!1,strength:50}})}else for(const i of[1,2,3,4,5,6])this.state.reservoirs.has(i)||this.state.reservoirs.set(i,{id:i,heat:0,volume:5e3,radiator:{deployed:!1,strength:50}});if(o.groupThrottles){this.state.groupThrottles.clear();for(const[i,s]of o.groupThrottles)this.state.groupThrottles.set(i,s)}else for(const i of[1,2,3,4])this.state.groupThrottles.set(i,1);if(o.probeThrottles){this.state.probeThrottles.clear();for(const[i,s]of o.probeThrottles)this.state.probeThrottles.set(i,s)}else for(const i of[1,2,3,4])this.state.probeThrottles.set(i,0);if(o.disabledShieldGroups){this.state.disabledShieldGroups.clear();for(const i of o.disabledShieldGroups)this.state.disabledShieldGroups.add(i)}else this.state.disabledShieldGroups.clear();for(const i of this.state.E.keys())this.state.E.set(i,0)}catch(o){console.error("Failed to load layout",o)}}}function Re(t){const e=new Map;for(const[o,i]of t.state.E.entries()){const s=t.state.entities.get(o),n=new Set;let r=i;if(s){if(n.add(s.type),s.destroyed&&n.add("destroyed"),s.type==="shield"){let a=s.groupId||0;t.state.disabledShieldGroups.has(a)&&n.add("disabled")}s.type==="source"?(s.active&&n.add("active"),r="S"):s.type==="sink"?r="X":s.type==="shield"?r="||":s.type==="probe"&&(r=i)}e.set(o,{value:r,tags:n,data:{temp:i,ent:s}})}return e}function Fe(t){const e=t.data?.temp||0,o={};return o.backgroundColor=Ge(e),t.tags.has("source")?(o.className="source-cell",o.color="black",t.tags.has("active")?o.text="ðŸ”†"+((t.data?.ent?.groupId||0)>0?t.data?.ent?.groupId:""):o.text="â­•"):t.tags.has("sink")?t.tags.has("destroyed")?(o.className="sink-cell-destroyed",o.text="ðŸ’¥",o.color="white"):(o.className="sink-cell",o.color="white",o.text="ðŸ•³ï¸"+((t.data?.ent?.groupId||0)>0?t.data?.ent?.groupId:"")):t.tags.has("shield")?(t.tags.has("destroyed")?(o.className="shield-cell-destroyed",o.text="ðŸ•¸",o.color="#a55"):t.tags.has("disabled")?(o.className="disabled-shield-cell",o.color="gray"):(o.className="shield-cell",o.color="black"),o.text="â›Š"+((t.data?.ent?.groupId||0)>0?t.data?.ent?.groupId:"")):t.tags.has("probe")?t.tags.has("destroyed")?(o.className="probe-cell-destroyed",o.text="â˜ ï¸",o.color="#555"):(o.className="probe-cell",o.text="âš¡"+((t.data?.ent?.groupId||0)>0?t.data?.ent?.groupId:"")):(o.className="monitor-cell",o.color=He(e)),o}function Ge(t){return`hsl(${(1-Math.min(Math.max(t/1450,0),1))*240}, 70%, 60%)`}function He(t){const i=(1-Math.min(Math.max(t/1450,0),1))*240,s=.7,n=.6,[r,l,a]=Oe(i/360,s,n);return .299*r+.587*l+.114*a>.5?"black":"white"}function Oe(t,e,o){let i,s,n;{const r=(p,u,f)=>(f<0&&(f+=1),f>1&&(f-=1),f<.16666666666666666?p+(u-p)*6*f:f<.5?u:f<.6666666666666666?p+(u-p)*(.6666666666666666-f)*6:p),l=o+e-o*e,a=2*o-l;i=r(a,l,t+1/3),s=r(a,l,t),n=r(a,l,t-1/3)}return[i,s,n]}const Ke={[-12]:"p",[-9]:"n",[-6]:"Âµ",[-3]:"m",0:"",3:"k",6:"M",9:"G",12:"T"};function Ue(t,e,o){return Math.max(e,Math.min(o,t))}function je(t,e=3){const o=String(t);if(typeof t!="number"||!Number.isFinite(t))return o.length<=e?o:o.slice(0,e);const i=t<0?"-":"",s=Math.abs(t);let n=0;s>0&&(n=Math.floor(Math.log10(s)/3)*3,n=Ue(n,-12,12));const r=Ke[n]??"",l=s/Math.pow(10,n),a=r.length,p=e-i.length-a;if(p<=0)return(i+r).padEnd(1,"?").slice(0,e);const u=Math.floor(l),m=String(u).length;if(m>p){const h=Math.round(l),v=String(h);return v.length<=p?i+v+r:(i+v).slice(0,p)+r}const E=p-m-1;let b;E>0?(b=l.toFixed(E),b.length>p&&(b=l.toFixed(0))):b=l.toFixed(0);let g=i+b+r;if(g.length>e){if(g.includes(".")){const[h]=b.split(".");g=i+h+r}g.length>e&&(g=g.slice(0,e))}return g}class _e{container;layout;cellCache=new Map;onCellClick=null;onCellMouseDown=null;onCellMouseEnter=null;onCellHover=null;onCellRightClick=null;constructor(e,o){this.container=e,this.layout=o,this.container.style.position="relative"}updateLayout(e){this.layout=e}render(e,o={}){const i=new Set;for(const[s,n]of e.entries()){if(typeof s!="string"){console.error("Invalid key type:",typeof s,s);continue}i.add(s);let r=this.cellCache.get(s),l;if(r)l=r.firstElementChild;else{const u=U(s),f=W(u,this.layout);r=document.createElement("div"),r.className="hex",r.style.left=`${f.x}px`,r.style.top=`${f.y}px`,l=document.createElement("div"),l.className="hex-inner",r.appendChild(l),r.addEventListener("click",()=>{this.onCellClick&&this.onCellClick(u)}),r.addEventListener("mousedown",m=>{m.buttons===1&&this.onCellMouseDown&&this.onCellMouseDown(u)}),r.addEventListener("mouseenter",m=>{m.buttons===1&&this.onCellMouseEnter&&this.onCellMouseEnter(u),this.onCellHover&&this.onCellHover(u)}),r.addEventListener("contextmenu",m=>{m.preventDefault(),this.onCellRightClick&&this.onCellRightClick(u)}),this.container.appendChild(r),this.cellCache.set(s,r)}const a=U(s),p=W(a,this.layout);if(r.style.left=`${p.x}px`,r.style.top=`${p.y}px`,n.value){let u=je(n.value,5);l.innerText!==u&&(l.innerText=u)}else l.innerText!==""&&(l.innerText="");if(o.styleFn){const u=o.styleFn(n,s);r.className="hex",u.className&&r.classList.add(u.className),u.backgroundColor?l.style.backgroundColor=u.backgroundColor:l.style.removeProperty("background-color"),u.color?l.style.color=u.color:l.style.removeProperty("color"),u.text!==void 0&&(l.innerText=u.text)}}for(const s of this.cellCache.keys())if(!i.has(s)){const n=this.cellCache.get(s);n&&n.remove(),this.cellCache.delete(s)}}}function S(t){const e=document.getElementById(t);if(!e)throw new Error(`Missing element #${t}`);return e}function K(t,e){const o=document.getElementById(t);o&&(o.textContent=e)}function Ye(t){t.innerHTML=`
  <div id="reactor-layout" style="display:flex; width:100vw; height:100vh; overflow:hidden; margin:0; padding:0;">
    \x3C!-- LEFT SIDEBAR: GAMEPLAY -->
    <div id="reactor-sidebar-left" style="width:300px; background:#222; color:#eee; display:flex; flex-direction:column; align-items:flex-start; padding:10px; border-right:1px solid #444; z-index:10; box-sizing:border-box; overflow-y:auto;">
      <h2 style="margin-top:0;">Reactor Control</h2>

      <div class="panel-section" style="display:flex; gap:8px; flex-wrap:wrap;">
        <button id="btn-play-pause">Play</button>
        <button id="btn-step">Step</button>
        <button id="btn-step-5">+5</button>
        <button id="btn-quench" style="background:#44a; color:white;">Quench</button>
      </div>

      <div style="margin:10px 0; font-size: 0.9em; display:flex; flex-direction:column; gap:5px;">
        <div style="display:flex; justify-content:space-between;">
           <span>Tick: <span id="tick-count">0</span></span>
           <span style="color:#aaa;">Time: <span id="tick-time">0.00</span>ms</span>
        </div>
        
        <div style="border-top:1px solid #444; padding-top:5px; margin-top:5px;">
           <div style="display:flex; justify-content:space-between; margin-bottom:2px;">
             <span style="color:#aaa;">Tick Budget</span>
             <span id="lbl-tick-budget" style="color:#fff;">100ms</span>
           </div>
           <input id="inp-tick-budget" type="range" min="0" max="1000" value="100" step="10" style="width:100%; cursor:pointer;">
        </div>
      </div>

       <hr style="border-color:#444; width:100%;" />
      <div style="font-size:0.85em; color:#aaa; margin-bottom:5px;">SOURCE CONTROLS</div>
      <div id="source-controls" style="margin-bottom:10px; width:100%;"></div>

      <hr style="border-color:#444; width:100%;" />
      <div style="font-size:0.85em; color:#aaa; margin-bottom:5px;">SHIELD CONTROLS</div>
      <div id="shield-controls" style="margin-bottom:10px; width:100%;"></div>

      <hr style="border-color:#444; width:100%;" />
      <div style="font-size:0.85em; color:#aaa; margin-bottom:5px;">RESERVOIRS</div>
      <div id="reservoir-controls" style="margin-bottom:10px; width:100%;"></div>

      <hr style="border-color:#444; width:100%;" />
      <div style="font-size:0.85em; color:#aaa; margin-bottom:5px;">CAPACITOR BANKS & PROBES</div>
      <div id="capacitor-controls" style="margin-bottom:10px; width:100%;"></div>
    </div>

    \x3C!-- MAIN VIEW -->
    <div id="reactor-main" style="flex:1; position:relative; background:#111; overflow:hidden;">
      <div id="game-board" style="position:absolute; top:0; left:0; width:100%; height:100%;"></div>
      
      \x3C!-- HUD -->
      <div style="position:absolute; top:10px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.6); padding:5px 15px; border-radius:15px; border:1px solid #444; color:#fff; font-family:monospace; pointer-events:none;">
        PERIMETER EXPOSURE: <span id="val-perimeter" style="font-weight:bold; color:#f88;">0.00</span>
      </div>

      \x3C!-- INSTRUCTIONS LEGEND -->
      <div style="position:absolute; bottom:10px; right:10px; background:rgba(0,0,0,0.7); padding:10px; border-radius:8px; border:1px solid #444; color:#ccc; font-size:0.85em; font-family:sans-serif; pointer-events:none; max-width:280px; z-index:20;">
        <div style="font-weight:bold; color:#fff; margin-bottom:5px; border-bottom:1px solid #555; padding-bottom:3px;">Mechanics & Controls</div>
        <ul style="margin:0; padding-left:16px; list-style-type:square; line-height:1.4em;">
           <li><b>Source Throttle (Left):</b> Increases output.</li>
           <li><b>Probes:</b> Destroyed by direct source exposure (LOS).</li>
           <li><b>Grouping:</b> Hover entity + Press <b>1-6</b>.</li>
           <li><b>Shields:</b> Toggle via control buttons.</li>
        </ul>
      </div>
    </div>

    \x3C!-- RIGHT SIDEBAR: EDITOR -->
    <div id="reactor-sidebar-right" style="width:280px; background:#222; color:#eee; display:flex; flex-direction:column; align-items:flex-start; padding:10px; border-left:1px solid #444; z-index:10; box-sizing:border-box;">
      <h2 style="margin-top:0;">Construction</h2>

      <div class="panel-section" style="display:flex; gap:8px; margin-bottom:10px; width:100%;">
        <button id="btn-save" style="flex:1; background:#444;">Save Layout</button>
        <button id="btn-load" style="flex:1; background:#444;">Load Layout</button>
      </div>

      <hr style="border-color:#444; width:100%;" />
      <div style="font-size:0.85em; color:#aaa; margin-bottom:5px;">TOOLS</div>
      <div class="panel-section" id="palette-toolbar" style="display:flex; gap:5px; flex-wrap:wrap; margin-bottom:10px;"></div>

      <hr style="border-color:#444; width:100%;" />
      <div style="font-size:0.85em; color:#aaa; margin-bottom:5px;">ENTITY LIST</div>
      <div id="entity-list" style="flex:1; overflow-y:auto; font-size:14px; width:100%;"></div>
    </div>
  </div>
  `}function Xe(){const o=Te(8).map(p=>x(p)),i=new De(o),s=(window.innerWidth-580)/2,n=window.innerHeight/2,r={size:{x:30,y:30},origin:{x:s,y:n},orientation:"pointy"},l=S("game-board"),a=new _e(l,r);return{game:i,hexGrid:a,layout:r}}function se(t){return t<50?"#aaf":t<150?"#fff":"#f88"}function ie(t,e,o){const i=Re(t);e.render(i,{styleFn:Fe}),K("tick-count",String(t.state.tickCount)),K("tick-time",o.lastTickDuration.toFixed(2)),K("val-perimeter",t.state.lastPerimeterEnergy.toFixed(2)),We(t,o,()=>ie(t,e,o));for(const n of[1,2,3,4]){const r=document.getElementById(`lbl-probe-total-${n}`);r&&(r.textContent=(t.state.totalEnergyCollected.get(n)??0).toFixed(1));const l=document.getElementById(`lbl-probe-rate-${n}`);if(l){const a=(t.state.lastTickEnergy.get(n)??0).toFixed(2);l.textContent=`+${a}/t`}}tt(t),ot(t),et(t);for(const n of[1,2,3,4]){const r=document.getElementById(`lbl-probe-total-${n}`),l=t.state.capacitors.get(n);r&&l&&(r.textContent=l.stored.toFixed(0));const a=document.getElementById(`lbl-probe-rate-${n}`);if(a){const p=t.state.lastCapacitorDelta.get(n)??0,u=p>=0?"+":"";a.textContent=`${u}${p.toFixed(2)}/t`,a.style.color=p>0?"#8f8":p<0?"#f88":"#aaa"}}}function Ve(t,e){const o=e?t.state.entities.get(e):void 0;return{selectedKey:e,entityType:o?o.type:"empty"}}function We(t,e,o){const i=Ve(t,e.selectedKey);i.selectedKey===e.lastSidebarSig.selectedKey&&i.entityType===e.lastSidebarSig.entityType||(qe(t,e,o),e.lastSidebarSig=i),Je(t,e.selectedKey)}function qe(t,e,o){const i=S("entity-list");if(i.innerHTML="",e.selectedKey){const s=t.state.entities.get(e.selectedKey),n=document.createElement("div");if(n.id="sidebar-detail-panel",n.style.background="#333",n.style.padding="10px",n.style.borderLeft=s?"4px solid #f88":"4px solid #555",n.style.marginBottom="15px",n.innerHTML=`
      <div style="font-size:1.1em; font-weight:bold;">
        ${s?s.type.toUpperCase():"EMPTY SPACE"}
      </div>
      <div style="font-family:monospace; color:#aaa; margin-bottom:5px;">${e.selectedKey}</div>
      <div style="margin-bottom:8px;">
        Temp: <strong id="val-temp" style="color:#fff">--</strong>
      </div>
    `,s){if(n.appendChild(document.createElement("hr")),s.type==="source"){const r=s;n.appendChild($("Power",r.power,a=>r.power=a,1,"inp-power")),n.appendChild($("Min Active",r.minActivation,a=>r.minActivation=a,1,"inp-minactive")),n.appendChild($("Group ID",r.groupId??1,a=>{r.groupId=X(a,1,4)},1,"inp-group"));const l=document.createElement("button");l.id="btn-active-toggle",l.style.marginTop="5px",l.style.width="100%",l.onclick=()=>{r.active=!r.active},n.appendChild(l)}if(s.type==="sink"){const r=s;n.appendChild($("Pull Rate",r.pullRate,a=>r.pullRate=Math.min(1,Math.max(0,a)),.01,"inp-pull")),n.appendChild($("Conductivity",r.conductivity,a=>r.conductivity=a,.1,"inp-cond")),n.appendChild($("Tolerance",r.heatTolerance??1400,a=>r.heatTolerance=a,100,"inp-tol")),n.appendChild($("Group ID",r.groupId??1,a=>{r.groupId=X(a,1,6)},1,"inp-sink-group"));const l=t.state.reservoirs.get(r.groupId??1);if(l){const a=document.createElement("div");a.style.marginTop="5px",a.style.color="#aaa",a.textContent=`Feeds Reservoir ${l.id} (${(l.heat/l.volume).toFixed(0)}Â°)`,n.appendChild(a)}}if(s.type==="shield"){const r=s;n.appendChild($("Conductivity",r.conductivity,l=>r.conductivity=l,.01,"inp-cond")),n.appendChild($("Tolerance",r.heatTolerance??2e3,l=>r.heatTolerance=l,10,"inp-tol")),n.appendChild($("Group ID",r.groupId??1,l=>{r.groupId=X(l,1,4)},1,"inp-shield-group"))}if(s.type==="probe"){const r=s;r.groupId===void 0&&(r.groupId=1),n.appendChild($("Tolerance",r.heatTolerance??1800,a=>r.heatTolerance=a,100,"inp-tol")),n.appendChild($("Group ID",r.groupId,a=>{r.groupId=X(a,1,4)},1,"inp-probe-group"));const l=document.createElement("div");l.style.color="#aaa",l.style.fontStyle="italic",l.style.marginTop="5px",l.textContent="Collects energy based on group delta E.",n.appendChild(l)}}else n.innerHTML+='<div style="color:#aaa; font-size:0.9em;">Select a tool to place a component.</div>';i.appendChild(n)}else{const s=document.createElement("div");s.style.padding="10px",s.style.color="#777",s.textContent="Select a cell to view details.",i.appendChild(s)}Qe(t,e,i,o)}function Je(t,e){if(!e)return;const o=t.state.E.get(e)??0,i=t.state.entities.get(e),s=document.getElementById("val-temp");if(s&&(s.textContent=o.toFixed(5),s.style.color=se(o)),!i)return;const n=(l,a)=>{const p=document.getElementById(l);p&&document.activeElement!==p&&(p.value=String(a))};if(i.type==="source"){const l=i;n("inp-power",l.power),n("inp-minactive",l.minActivation),n("inp-group",l.groupId??1);const a=document.getElementById("btn-active-toggle");a&&(a.textContent=l.active?"ACTIVE":"INACTIVE",a.style.background=l.active?"#2b2":"#b22")}if(i.type==="sink"){const l=i;n("inp-cond",l.conductivity),n("inp-pull",l.pullRate),n("inp-tol",l.heatTolerance??1400),n("inp-sink-group",l.groupId??1)}if(i.type==="shield"&&(n("inp-cond",i.conductivity),n("inp-tol",i.heatTolerance??2e3),n("inp-shield-group",i.groupId??1)),i.type==="probe"){const l=i;n("inp-tol",l.heatTolerance??1800),l.groupId===void 0&&(l.groupId=1),n("inp-probe-group",l.groupId)}const r=document.getElementById(`list-sum-${e}`);r&&(r.textContent=de(i))}function Qe(t,e,o,i){const s={source:[],sink:[],shield:[],probe:[]};for(const[r,l]of t.state.entities){const a=l.type;s[a]&&s[a].push({key:r,entity:l})}const n=(r,l)=>{if(l.length===0)return;const a=document.createElement("div");a.textContent=r.toUpperCase(),a.style.fontSize="0.85em",a.style.color="#888",a.style.marginTop="10px",a.style.borderBottom="1px solid #444",o.appendChild(a);for(const p of l){const u=document.createElement("div");u.style.padding="4px 8px",u.style.cursor="pointer",u.style.fontSize="0.9em",u.style.borderBottom="1px solid #333",p.key===e.selectedKey&&(u.style.background="#444"),u.onclick=()=>{e.selectedKey=p.key,i()},u.innerHTML=`
        <div style="display:flex; justify-content:space-between;">
          <span>${p.key}</span>
          <span id="list-sum-${p.key}" style="color:#aaa;">${de(p.entity)}</span>
        </div>
      `,o.appendChild(u)}};n("Sources",s.source),n("Sinks",s.sink),n("Shields",s.shield),n("Probes",s.probe)}function de(t){return t?t.type==="source"?`G${t.groupId} â€¢ Pwr: ${t.power}`:t.type==="sink"?`G${t.groupId} â€¢ Pull: ${t.pullRate}`:t.type==="shield"?`G${t.groupId} â€¢ Cond: ${t.conductivity}`:t.type==="probe"?`G${t.groupId}`:"":""}function X(t,e,o){return Math.max(e,Math.min(o,Math.round(t)))}function $(t,e,o,i=1,s){const n=document.createElement("div");n.style.marginTop="4px",n.style.display="flex",n.style.justifyContent="space-between",n.style.alignItems="center";const r=document.createElement("span");r.style.fontSize="0.9em",r.style.color="#ccc",r.textContent=t;const l=document.createElement("input");s&&(l.id=s),l.type="number",l.value=String(e),l.style.width="70px",l.style.background="#222",l.style.color="#fff",l.style.border="1px solid #555",l.style.padding="2px",l.step=String(i);const a=()=>{const p=parseFloat(l.value);Number.isFinite(p)&&o(p)};return l.addEventListener("change",a),l.addEventListener("input",a),n.appendChild(r),n.appendChild(l),n}function Ze(t){const e=S("palette-toolbar"),o=[{id:"select",label:"Select"},{id:"source",label:"Source",color:"#f88"},{id:"sink",label:"Sink",color:"#88f"},{id:"shield",label:"Shield",color:"#8f8"},{id:"probe",label:"Probe",color:"#ff8"},{id:"erase",label:"Erase",color:"#aaa"}],i=s=>{t.activeTool=s,document.querySelectorAll(".palette-btn").forEach(n=>{const r=n,l=r.dataset.tool===s;r.style.background=l?"#66a":"#333",r.style.borderColor=l?"#aaf":"#555"})};for(const s of o){const n=document.createElement("button");n.className="palette-btn",n.dataset.tool=s.id,n.textContent=s.label,n.style.flex="1 0 30%",n.style.padding="5px 0",n.style.cursor="pointer",n.style.border="1px solid #555",n.style.background="#333",n.style.color="#eee",s.color&&(n.style.borderLeft=`3px solid ${s.color}`),n.onclick=()=>i(s.id),e.appendChild(n)}i("select")}function pe(t,e,o){const i=S("source-controls");i.innerHTML="",i.style.display="flex",i.style.flexDirection="column",i.style.gap="8px";for(const s of[1,2,3,4]){const n=document.createElement("div");n.style.background="#282828",n.style.padding="5px",n.style.border="1px solid #444";const r=t.state.groupThrottles.get(s)??0,l=Math.round(r*100),a=document.createElement("div");a.style.display="flex",a.style.justifyContent="space-between",a.style.marginBottom="2px",a.innerHTML=`
      <span style="font-size:0.9em; color:#aaa; font-weight:bold;">GROUP ${s}</span>
      <span id="lbl-grp-${s}" style="font-size:0.9em; color:#fff;">${l}%</span>
    `;const p=document.createElement("input");p.type="range",p.min="0",p.max="100",p.value=String(l),p.style.width="100%",p.style.cursor="pointer",p.style.marginBottom="5px",p.oninput=()=>{const f=parseInt(p.value,10);t.state.groupThrottles.set(s,f/100),K(`lbl-grp-${s}`,`${f}%`),e.isPlaying||o()};const u=document.createElement("div");u.id=`source-list-group-${s}`,u.style.fontSize="0.8em",u.style.color="#aaa",u.style.minHeight="10px",n.appendChild(a),n.appendChild(p),n.appendChild(u),i.appendChild(n)}}function et(t){const e=new Map;for(const o of t.state.entities.values())if(o.type==="source"){const i=o,s=i.groupId||1;e.has(s)||e.set(s,[]),e.get(s).push(i)}for(const o of[1,2,3,4]){const i=document.getElementById(`source-list-group-${o}`);if(!i)continue;const s=e.get(o)||[];if(s.length===0){i.innerHTML='<div style="padding:2px; font-style:italic; color:#555;">No sources</div>';continue}const n=new Map;i.querySelectorAll(".src-row").forEach(l=>{const a=l.getAttribute("data-key");a&&n.set(a,l)});const r=new Set;s.sort((l,a)=>x(l.pos).localeCompare(x(a.pos)));for(const l of s){const a=x(l.pos);r.add(a);const p=t.state.E.get(a)??0,u=t.state.lastDeltaE.get(a)??0,f=se(p),m=l.active?"#ddd":"#777",E=l.active?"â—":"â—‹",b=u>=0?"+":"",g=u>.1?"#f88":u<-.1?"#aaf":"#666";let h=n.get(a);h||(h=document.createElement("div"),h.className="src-row",h.setAttribute("data-key",a),h.style.display="flex",h.style.justifyContent="space-between",h.style.alignItems="center",h.style.background="#00000030",h.style.padding="2px 4px",h.style.marginTop="1px",h.style.borderRadius="2px",i.appendChild(h)),h.innerHTML=`
                <span style="color:${m};" title="${l.active?"Active":"Inactive"}">${E} ${a}</span>
                <span style="color:#aaa;">P:${l.power}</span>
                <div style="display:flex; flex-direction:column; align-items:flex-end;">
                    <span style="color:${f}; line-height:1em;">${p.toFixed(0)}Â°</span>
                    <span style="color:${g}; font-size:0.7em; line-height:1em;">${b}${u.toFixed(1)}/t</span>
                </div>
            `}for(const[l,a]of n)r.has(l)||a.remove()}}function ue(t,e){const o=S("shield-controls");o.innerHTML="",o.style.display="grid",o.style.gridTemplateColumns="repeat(4, 1fr)",o.style.gap="5px";for(const i of[1,2,3,4]){const s=document.createElement("button");s.textContent=`â›Š${i}`,s.style.padding="8px 0",s.style.cursor="pointer",s.style.fontWeight="bold";const n=()=>{const r=t.state.disabledShieldGroups.has(i);s.style.background=r?"#422":"#252",s.style.border=r?"1px solid #522":"1px solid #5a5",s.style.color=r?"#aaa":"#fff",s.style.opacity=r?"0.6":"1.0"};n(),s.onclick=()=>{t.toggleShieldGroup(i),n(),e()},o.appendChild(s)}}function fe(t,e){const o=S("capacitor-controls");o.innerHTML="",o.style.display="flex",o.style.flexDirection="column",o.style.gap="8px";for(const i of[1,2,3,4]){const s=t.state.capacitors.get(i);if(!s)continue;const n=document.createElement("div");n.style.background="#222",n.style.padding="5px",n.style.border="1px solid #444",n.style.fontSize="0.85em";const r=t.state.probeThrottles.get(i)??0,l=Math.round(r*100),a=document.createElement("div");a.style.display="flex",a.style.justifyContent="space-between",a.style.marginBottom="4px",a.style.alignItems="center",a.innerHTML=`
      <div style="display:flex; flex-direction:column;">
        <span style="color:#aaa; font-weight:bold;">BANK ${i}</span>
        <span id="lbl-probe-val-${i}" style="color:#8f8; font-size:0.9em;">Probe: ${l}%</span>
      </div>
      <div style="text-align:right;">
         <span id="lbl-cap-val-${i}" style="color:#fff;">${s.stored.toFixed(0)} / ${s.capacity}</span>
      </div>
    `,n.appendChild(a);const p=document.createElement("input");p.type="range",p.min="0",p.max="100",p.value=String(l),p.style.width="100%",p.style.cursor="pointer",p.style.marginBottom="4px",p.oninput=()=>{const h=parseInt(p.value,10);t.state.probeThrottles.set(i,h/100);const v=document.getElementById(`lbl-probe-val-${i}`);v&&(v.textContent=`Probe: ${h}%`),k.isPlaying||e()},n.appendChild(p);const u={id:`prog-cap-${i}`,height:"6px",color:"#4d4"},f=document.createElement("div");f.style.width="100%",f.style.height=u.height,f.style.background="#000",f.style.marginTop="2px",f.style.marginBottom="4px",f.innerHTML=`<div id="${u.id}" style="width:0%; height:100%; background:${u.color}; transition: width 0.1s;"></div>`,n.appendChild(f);const m=document.createElement("div");m.style.display="flex",m.style.gap="4px",m.style.alignItems="center";const E=document.createElement("button");E.textContent="âš¡",E.title="Discharge (Surcharge)",E.style.width="24px",E.style.height="24px",E.style.padding="0",E.style.cursor="pointer",E.style.background="#d84",E.style.border="1px solid #a62",E.onclick=()=>{t.dischargeBank(i)?e():console.log("Not enough energy to discharge")},m.appendChild(E);const b=document.createElement("div");b.style.display="flex",b.style.justifyContent="space-between",b.style.fontSize="0.75em",b.style.color="#888",b.style.marginBottom="2px",b.innerHTML=`
      <span>Cap: <span id="lbl-probe-total-${i}" style="color:#ccc;">0</span></span>
      <span id="lbl-probe-rate-${i}" style="color:#ccc;">+0.00/t</span>
    `,n.appendChild(b);const g=(h,v,J)=>{const D=document.createElement("div");D.style.flex="1",D.innerHTML=`<div style="font-size:0.7em; color:#777;">${h}</div>`;const M=document.createElement("input");M.type="number",M.value=String(v),M.style.width="100%",M.style.background="#111",M.style.border="1px solid #333",M.style.color="#ccc",M.style.fontSize="0.8em",M.onchange=()=>{const j=t.state.capacitors.get(i);j&&(J(j,parseFloat(M.value)),e())},D.appendChild(M),m.appendChild(D)};g("Max",s.capacity,(h,v)=>h.capacity=v),g("Drain",s.drainRate,(h,v)=>h.drainRate=v),g("Cost",s.surchargeCost,(h,v)=>h.surchargeCost=v),n.appendChild(m),o.appendChild(n)}}function tt(t){for(const[e,o]of t.state.capacitors){const i=document.getElementById(`prog-cap-${e}`),s=document.getElementById(`lbl-cap-val-${e}`);if(i&&s){const n=Math.min(100,o.stored/o.capacity*100);i.style.width=`${n}%`,o.stored>=o.capacity?i.style.backgroundColor="#f44":i.style.backgroundColor="#4d4",s.textContent=`${o.stored.toFixed(0)} / ${o.capacity}`}}}function ye(t,e){const o=S("reservoir-controls");o.innerHTML="",o.style.display="grid",o.style.gridTemplateColumns="1fr 1fr 1fr",o.style.gap="5px";for(const[i]of t.state.reservoirs){const s=t.state.reservoirs.get(i),n=document.createElement("div");n.className="reservoir-card",n.setAttribute("data-id",String(i)),n.style.background="#222",n.style.border="1px solid #444",n.style.padding="4px",n.style.fontSize="0.8em";const r=document.createElement("div");r.style.fontWeight="bold",r.style.color="#aaa",r.textContent=`RES ${i}`,n.appendChild(r);const l=document.createElement("div");l.id=`res-temp-${i}`,l.style.color="#fff",l.style.marginBottom="2px",l.textContent="0Â°",n.appendChild(l);const a=document.createElement("div");a.style.display="flex",a.style.gap="2px",a.style.marginBottom="2px";const p=(f,m,E)=>{const b=document.createElement("div");b.style.flex="1",b.innerHTML=`<div style="font-size:0.6em; color:#777;">${f}</div>`;const g=document.createElement("input");g.type="number",g.value=String(m),g.style.width="100%",g.style.background="#111",g.style.border="1px solid #333",g.style.color="#ccc",g.style.fontSize="0.85em",g.onchange=()=>{const h=parseFloat(g.value);if(!isNaN(h)){const v=t.state.reservoirs.get(i);v&&(E(v,h),e())}},b.appendChild(g),a.appendChild(b)};p("Vol",s.volume,(f,m)=>f.volume=Math.max(1,m)),p("RadStr",s.radiator.strength,(f,m)=>f.radiator.strength=Math.max(0,m)),n.appendChild(a);const u=document.createElement("button");u.id=`btn-rad-${i}`,u.textContent="RAD",u.style.width="100%",u.style.fontSize="0.7em",u.style.padding="2px",u.style.cursor="pointer",u.onclick=()=>{const f=t.state.reservoirs.get(i);f&&(f.radiator.deployed=!f.radiator.deployed,e())},n.appendChild(u),o.appendChild(n)}}function ot(t){for(const[e,o]of t.state.reservoirs){const i=document.getElementById(`res-temp-${e}`);if(i){const n=o.heat/o.volume;i.textContent=`${n.toFixed(0)}Â°`,i.style.color=se(n)}const s=document.getElementById(`btn-rad-${e}`);s&&(s.style.background=o.radiator.deployed?"#aaf":"#333",s.style.color=o.radiator.deployed?"#000":"#888",s.style.border=o.radiator.deployed?"1px solid #fff":"1px solid #555")}}function nt(t,e,o,i){const s=n=>{o.activeTool==="select"?o.selectedKey=n:o.activeTool==="erase"?(t.setEntity(n,"empty"),o.selectedKey===n&&(o.selectedKey=null)):t.setEntity(n,o.activeTool),i()};e.onCellMouseDown=n=>{o.isPointerDown=!0,s(x(n))},e.onCellMouseEnter=n=>{o.isPointerDown&&s(x(n))},e.onCellHover=n=>{o.hoveredKey=x(n)},e.onCellClick=n=>{s(x(n))},e.onCellRightClick=n=>{console.log("Right click at",n)},window.addEventListener("mouseup",()=>o.isPointerDown=!1),window.addEventListener("mouseleave",()=>o.isPointerDown=!1)}function st(t,e,o,i,s){S("btn-play-pause").onclick=()=>{e.isPlaying=!e.isPlaying,e.isPlaying?(S("btn-play-pause").textContent="Pause",i()):(S("btn-play-pause").textContent="Play",s(),o())},S("btn-step").onclick=()=>{t.tick(),o()},S("btn-step-5").onclick=()=>{for(let r=0;r<5;r++)t.tick();o()},S("btn-quench").onclick=()=>{for(const r of t.state.E.keys())t.state.E.set(r,0);for(const r of t.state.reservoirs.values())r.heat=0;o(),console.log("Reactor Quenched")};const n=S("inp-tick-budget");n.oninput=()=>{const r=parseInt(n.value,10);e.tickBudgetMs=r,K("lbl-tick-budget",`${r}ms`)},S("btn-save").onclick=async()=>{const r=t.serialize();try{if(window.showSaveFilePicker){const a=await(await window.showSaveFilePicker({suggestedName:"reactor_layout.json",types:[{description:"JSON File",accept:{"application/json":[".json"]}}]})).createWritable();await a.write(r),await a.close()}else{const l=new Blob([r],{type:"application/json"}),a=URL.createObjectURL(l),p=document.createElement("a");p.href=a,p.download="reactor_layout.json",document.body.appendChild(p),p.click(),document.body.removeChild(p),URL.revokeObjectURL(a)}console.log("Layout exported")}catch(l){console.error("Save cancelled or failed",l)}},S("btn-load").onclick=()=>{const r=document.createElement("input");r.type="file",r.accept=".json",r.style.display="none",document.body.appendChild(r),r.onchange=l=>{const a=l.target.files?.[0];if(!a)return;const p=new FileReader;p.onload=u=>{const f=u.target?.result;f&&(t.deserialize(f),pe(t,e,o),ue(t,o),ye(t,o),fe(t,o),o(),console.log("Layout loaded from file"))},p.readAsText(a),document.body.removeChild(r)},r.click()}}function it(t,e,o){window.addEventListener("keydown",i=>{if(["0","1","2","3","4","5","6","7","8","9"].includes(i.key)){const s=parseInt(i.key,10);if(e.hoveredKey){const n=t.state.entities.get(e.hoveredKey);n&&(n.type==="source"||n.type==="shield"||n.type==="probe"||n.type==="sink")&&(n.groupId=s,o())}}})}const rt=S("app");Ye(rt);const{game:A,hexGrid:q,layout:oe}=Xe(),k={isPlaying:!1,rafId:null,activeTool:"select",selectedKey:null,isPointerDown:!1,hoveredKey:null,lastSidebarSig:{selectedKey:null,entityType:"empty"},tickBudgetMs:100,lastTickTime:0,lastTickDuration:0},B=()=>ie(A,q,k);Ze(k);pe(A,k,B);ue(A,B);ye(A,B);fe(A,B);nt(A,q,k,B);st(A,k,B,lt,at);it(A,k,B);function he(t){if(!k.isPlaying)return;if(t-k.lastTickTime>=k.tickBudgetMs){const o=performance.now();A.tick();const i=performance.now();k.lastTickDuration=i-o,k.lastTickTime=t}ie(A,q,k),k.rafId=requestAnimationFrame(he)}function lt(){k.rafId&&cancelAnimationFrame(k.rafId),k.rafId=requestAnimationFrame(he)}function at(){k.rafId&&cancelAnimationFrame(k.rafId),k.rafId=null}B();window.addEventListener("resize",()=>{const t=(window.innerWidth-580)/2,e=window.innerHeight/2;oe.origin.x=t,oe.origin.y=e,q.updateLayout(oe),B()});</script>
    <style rel="stylesheet" crossorigin>:root{--hex-size: 30px;--hex-width: calc(var(--hex-size) * 1.732);--hex-height: calc(var(--hex-size) * 2);--bg-color: #1e1e2e;--hex-bg: #45475a;--hex-hover: #585b70;--hex-revealed: #313244;--text-color: #cdd6f4;--mine-color: #f38ba8;--flag-color: #f9e2af}body{margin:0;display:flex;place-items:center;min-width:320px;min-height:100vh;background-color:var(--bg-color);color:var(--text-color);font-family:Inter,sans-serif;overflow:hidden}#app{position:relative;width:100%;height:100vh;display:flex;justify-content:center;align-items:center}#game-board{position:relative}.hex{width:var(--hex-width);height:var(--hex-height);clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%);background-color:#000;position:absolute;display:flex;justify-content:center;align-items:center;cursor:pointer;transition:transform .1s;transform:translate(-50%,-50%) scale(1);-webkit-user-select:none;user-select:none}.hex-inner{width:98%;height:98%;clip-path:inherit;background-color:var(--hex-bg);display:flex;justify-content:center;align-items:center;font-weight:700;font-size:14px;color:var(--text-color);transition:background-color .2s}.hex:hover{transform:translate(-50%,-50%) scale(1.15);z-index:10}.hex:hover .hex-inner{background-color:var(--hex-hover)}.hex.revealed{background-color:var(--hex-revealed);cursor:default}.hex.mine{background-color:var(--mine-color)}.hex.flagged:after{content:"ðŸš©";font-size:16px}.probe-cell-destroyed{opacity:.6;filter:grayscale(100%)}.disabled-shield-cell{opacity:.3;border:1px dashed #555;color:#777}.shield-cell-destroyed{background-color:#311;opacity:.8;border:2px solid #522;color:#a55;filter:sepia(.5)}.sink-cell-destroyed{background-color:#222;opacity:.8;border:2px solid #822;color:#e55}</style>
  </head>
  <body>
    <div id="app"></div>
  </body>
</html>
